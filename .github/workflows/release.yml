name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          dotnet-quality: "preview"

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$TAG" >> $GITHUB_OUTPUT
          echo "Extracted version: $TAG"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release -p:Version=${{ steps.version.outputs.VERSION }}

      - name: Run tests
        run: dotnet test --no-build --configuration Release

      - name: Pack Fleece.Core
        run: dotnet pack src/Fleece.Core/Fleece.Core.csproj --no-build --configuration Release -p:PackageVersion=${{ steps.version.outputs.VERSION }} --output ./nupkgs

      - name: Pack Fleece.Cli
        run: dotnet pack src/Fleece.Cli/Fleece.Cli.csproj --no-build --configuration Release -p:PackageVersion=${{ steps.version.outputs.VERSION }} --output ./nupkgs

      - name: Publish to NuGet
        run: dotnet nuget push ./nupkgs/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Update version in source
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i "s|<Version>.*</Version>|<Version>${VERSION}</Version>|" Directory.Build.props
          echo "Updated Directory.Build.props to version ${VERSION}"

      - name: Commit version update
        env:
          GH_TOKEN: ${{ secrets.VERSION_UPDATE_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
          git add Directory.Build.props
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            git commit -m "chore: update version to ${{ steps.version.outputs.VERSION }} [skip ci]"
            git push origin HEAD:main
          fi
        continue-on-error: true
